<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Soccer Predictions (spi.csv)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:20px;max-width:980px}
    h1{font-size:1.4rem;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
    input,button{padding:10px;border:1px solid #ddd;border-radius:8px}
    input{min-width:240px}
    button{cursor:pointer;background:#f4f6ff;border-color:#cbd5ff}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:center}
    th{background:#fafafa}
    .note{color:#666;font-size:.9rem;margin-top:8px}
  </style>
</head>
<body>
  <h1>Soccer Predictions (อ่านจากไฟล์ <code>spi.csv</code>)</h1>

  <div class="row">
    <label>Home:
      <input id="home" list="teams" placeholder="เช่น Manchester City">
    </label>
    <label>Away:
      <input id="away" list="teams" placeholder="เช่น Arsenal">
    </label>
    <button id="go">Lookup</button>
    <button id="today">วันนี้ทั้งหมด</button>
  </div>
  <!-- รายชื่อทีม (จะถูกเติมอัตโนมัติเมื่อโหลดไฟล์) -->
  <datalist id="teams"></datalist>

  <div id="out" class="note">กรอกชื่อทีม (อังกฤษ) แล้วกด Lookup หรือกด “วันนี้ทั้งหมด”</div>

  <!-- PapaParse สำหรับอ่าน CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    const pct = p => (p*100).toFixed(1) + "%";
    const fair = p => p>0 ? (1/p).toFixed(2) : "-";
    const iso = d => new Date(d).toISOString().slice(0,10);

    let CACHE = [];
    let TEAM_SET = new Set();

    // โหลด CSV จาก repo เดียวกัน (ไม่ติด CORS)
    async function ensureData(){
      if (CACHE.length) return CACHE;
      const r = await fetch("./spi.csv", {cache:"no-store"});
      if(!r.ok) throw new Error("ไม่พบไฟล์ spi.csv ใน repo");
      const text = await r.text();
      const parsed = Papa.parse(text, {header:true, dynamicTyping:true, skipEmptyLines:true});

      // ต้องมีคอลัมน์: date,league,team1,team2,prob1,probdraw,prob2,over25
      const need = ["date","league","team1","team2","prob1","probdraw","prob2","over25"];
      for(const k of need){
        if(!parsed.meta.fields.includes(k)){
          throw new Error("ขาดคอลัมน์: "+k+" ใน spi.csv");
        }
      }

      CACHE = parsed.data.map(r => ({
        date: String(r.date).slice(0,10),
        league: r.league,
        team1: r.team1,
        team2: r.team2,
        prob1: +r.prob1,
        probdraw: +r.probdraw,
        prob2: +r.prob2,
        over25: +r.over25
      })).filter(x => x.date && x.team1 && x.team2);

      // เติมรายชื่อทีมลง datalist (autocomplete)
      TEAM_SET = new Set();
      for(const x of CACHE){ TEAM_SET.add(x.team1); TEAM_SET.add(x.team2); }
      const dl = $("teams");
      dl.innerHTML = Array.from(TEAM_SET).sort().map(t=>`<option value="${t}">`).join("");
      return CACHE;
    }

    // ---------- ฟัซซี่แมตช์ชื่อทีม ----------
    // ทำความสะอาดตัวอักษร (lowercase, ตัดช่องว่าง/จุด/ขีด)
    const norm = s => (s||"").toLowerCase().replace(/[\.\-']/g," ").replace(/\s+/g," ").trim();

    // Levenshtein distance แบบง่าย
    function levenshtein(a,b){
      a = norm(a); b = norm(b);
      const m = a.length, n = b.length;
      if(m===0) return n; if(n===0) return m;
      const dp = Array(n+1).fill(0).map((_,i)=>i);
      for(let i=1;i<=m;i++){
        let prev = dp[0];
        dp[0] = i;
        for(let j=1;j<=n;j++){
          const temp = dp[j];
          dp[j] = Math.min(
            dp[j] + 1,               // delete
            dp[j-1] + 1,             // insert
            prev + (a[i-1]===b[j-1] ? 0 : 1) // replace
          );
          prev = temp;
        }
      }
      return dp[n];
    }
    function similarity(a,b){
      a = norm(a); b = norm(b);
      if(!a || !b) return 0;
      const dist = levenshtein(a,b);
      const maxLen = Math.max(a.length, b.length) || 1;
      return 1 - dist/maxLen; // 0..1 (สูง=ใกล้เคียง)
    }
    // หาชื่อทีมที่ “ใกล้เคียงที่สุด” จากชุดทีมในไฟล์
    function bestTeamName(input){
      const name = norm(input);
      if(!name) return null;
      let best = null, bestScore = -1;
      for(const t of TEAM_SET){
        const s = similarity(name, t);
        if(s > bestScore){ bestScore = s; best = t; }
      }
      // กำหนด threshold พอเหมาะ (>= 0.55 ถือว่าโอเค)
      return bestScore >= 0.55 ? best : null;
    }

    function rowHTML(row){
      return `
        <tr>
          <td>${row.date}</td>
          <td>${row.league}</td>
          <td>${row.team1}</td>
          <td>${row.team2}</td>
          <td>${pct(row.prob1)}</td>
          <td>${pct(row.probdraw)}</td>
          <td>${pct(row.prob2)}</td>
          <td>${fair(row.prob1)}</td>
          <td>${fair(row.probdraw)}</td>
          <td>${fair(row.prob2)}</td>
          <td>${pct(row.over25)}</td>
        </tr>`;
    }

    // ปุ่ม Lookup (ทนชื่อไม่ตรงมากขึ้น + เลือกแมตช์ล่าสุด)
    $("go").onclick = async ()=>{
      $("out").textContent = "กำลังค้นหา…";
      const rows = await ensureData();

      // แปลงชื่อที่ผู้ใช้พิมพ์ให้เป็นชื่อที่ดีที่สุดจากไฟล์
      const hIn = $("home").value.trim();
      const aIn = $("away").value.trim();
      const h = bestTeamName(hIn) || hIn;
      const a = bestTeamName(aIn) || aIn;

      // หาแมตช์ที่ทีมตรงกัน (ยอมให้สลับเหย้า-เยือนได้)
      let candidates = rows.filter(r =>
        (norm(r.team1)===norm(h) && norm(r.team2)===norm(a)) ||
        (norm(r.team1)===norm(a) && norm(r.team2)===norm(h))
      );

      // ถ้าไม่มี exact หลังฟัซซี่: ลองแบบ “มีคำบางส่วน” (includes)
      if(!candidates.length){
        candidates = rows.filter(r =>
          (norm(r.team1).includes(norm(h)) && norm(r.team2).includes(norm(a))) ||
          (norm(r.team1).includes(norm(a)) && norm(r.team2).includes(norm(h)))
        );
      }

      if(!candidates.length){
        // เสนอชื่อที่ใกล้เคียงสุดให้ผู้ใช้เลือก
        const hintH = bestTeamName(hIn);
        const hintA = bestTeamName(aIn);
        $("out").innerHTML = `
          ไม่พบคู่นี้ใน <code>spi.csv</code><br>
          <div class="note">
            ลองสะกดตามนี้ดูไหม?:
            <ul>
              <li>Home: <b>${hintH || "ไม่พบชื่อที่ใกล้เคียง"}</b></li>
              <li>Away: <b>${hintA || "ไม่พบชื่อที่ใกล้เคียง"}</b></li>
            </ul>
            หรือเลือกจากรายการ Autocomplete ที่ช่องกรอกชื่อทีม
          </div>`;
        return;
      }

      // เลือก “เรคคอร์ดล่าสุด” ตามวันที่ (YYYY-MM-DD)
      candidates.sort((x,y)=> x.date<y.date ? 1 : -1);
      const m = candidates[0];

      $("out").innerHTML = `
        <h3>${m.team1} vs ${m.team2} — ${m.league} (${m.date})</h3>
        <table>
          <tr>
            <th>Date</th><th>League</th><th>Home</th><th>Away</th>
            <th>H%</th><th>D%</th><th>A%</th>
            <th>H Fair</th><th>D Fair</th><th>A Fair</th>
            <th>Over 2.5</th>
          </tr>
          ${rowHTML(m)}
        </table>`;
    };

    // ปุ่ม วันนี้ทั้งหมด (ถ้าวันนี้ว่าง จะ fallback ไป “วันที่ล่าสุดในไฟล์”)
    $("today").onclick = async ()=>{
      $("out").textContent = "กำลังโหลด…";
      const rows = await ensureData();
      const today = iso(new Date());
      let lst = rows.filter(r => r.date===today);

      if(!lst.length){
        const last = rows.map(r=>r.date).filter(Boolean).sort().pop();
        lst = rows.filter(r=>r.date===last);
        if(!lst.length){ $("out").innerHTML = "ยังไม่พบข้อมูลใน spi.csv"; return; }
        $("out").innerHTML = `
          <h3>รายการล่าสุดในไฟล์ (${last})</h3>
          <table>
            <tr>
              <th>Date</th><th>League</th><th>Home</th><th>Away</th>
              <th>H%</th><th>D%</th><th>A%</th>
              <th>H Fair</th><th>D Fair</th><th>A Fair</th>
              <th>Over 2.5</th>
            </tr>
            ${lst.sort((a,b)=>a.team1.localeCompare(b.team1)).map(rowHTML).join("")}
          </table>`;
        return;
      }

      $("out").innerHTML = `
        <h3>รายการวันนี้ (${today})</h3>
        <table>
          <tr>
            <th>Date</th><th>League</th><th>Home</th><th>Away</th>
            <th>H%</th><th>D%</th><th>A%</th>
            <th>H Fair</th><th>D Fair</th><th>A Fair</th>
            <th>Over 2.5</th>
          </tr>
          ${lst.sort((a,b)=>a.team1.localeCompare(b.team1)).map(rowHTML).join("")}
        </table>`;
    };

    // โหลดข้อมูลทันที เพื่อให้ datalist ขึ้นชื่อทีมตั้งแต่เปิดหน้า
    ensureData().catch(e=>{
      $("out").innerHTML = "โหลด spi.csv ไม่สำเร็จ: " + e.message;
    });
  </script>
</body>
</html>
