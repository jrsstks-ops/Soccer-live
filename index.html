<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Soccer Predictions</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
         margin:20px;max-width:960px;}
    h1{font-size:1.4rem;margin-bottom:12px;}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
    input,button{padding:8px;border:1px solid #ccc;border-radius:6px;}
    input{min-width:220px;}
    button{cursor:pointer;background:#f2f2f2;}
    table{border-collapse:collapse;width:100%;margin-top:12px;}
    th,td{border:1px solid #ddd;padding:6px;text-align:center;}
    th{background:#f9f9f9;}
    .note{color:#666;font-size:.9rem;margin-top:8px;}
  </style>
</head>
<body>
  <h1>Soccer Predictions (จากไฟล์ spi.csv)</h1>

  <div class="row">
    <label>Home: <input id="home" placeholder="เช่น Manchester City"></label>
    <label>Away: <input id="away" placeholder="เช่น Arsenal"></label>
    <button id="go">Lookup</button>
    <button id="today">วันนี้ทั้งหมด</button>
  </div>

  <div id="out" class="note">กรอกชื่อทีมแล้วกด Lookup หรือกดปุ่ม “วันนี้ทั้งหมด”</div>

  <!-- โหลด PapaParse สำหรับอ่าน CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    const pct = p => (p*100).toFixed(1)+"%";
    const fair = p => p>0 ? (1/p).toFixed(2) : "-";
    const iso = d => new Date(d).toISOString().slice(0,10);

    let CACHE = [];

    // โหลด CSV จาก repo เดียวกัน
    async function ensureData(){
      if (CACHE.length) return CACHE;
      const r = await fetch("./spi.csv", {cache:"no-store"});
      if(!r.ok) throw new Error("ไม่พบไฟล์ spi.csv ใน repo");
      const text = await r.text();
      const parsed = Papa.parse(text, {header:true, dynamicTyping:true, skipEmptyLines:true});

      CACHE = parsed.data.map(r => ({
        date: String(r.date).slice(0,10),
        league: r.league,
        team1: r.team1,
        team2: r.team2,
        prob1: +r.prob1,
        probdraw: +r.probdraw,
        prob2: +r.prob2,
        over25: +r.over25
      })).filter(x => x.date && x.team1 && x.team2);
      return CACHE;
    }

    function rowHTML(row){
      return `
        <tr>
          <td>${row.date}</td>
          <td>${row.league}</td>
          <td>${row.team1}</td>
          <td>${row.team2}</td>
          <td>${pct(row.prob1)}</td>
          <td>${pct(row.probdraw)}</td>
          <td>${pct(row.prob2)}</td>
          <td>${fair(row.prob1)}</td>
          <td>${fair(row.probdraw)}</td>
          <td>${fair(row.prob2)}</td>
          <td>${pct(row.over25)}</td>
        </tr>`;
    }

    // ปุ่ม Lookup
    $("go").onclick = async ()=>{
      $("out").textContent = "กำลังค้นหา…";
      const rows = await ensureData();
      const h = $("home").value.trim().toLowerCase();
      const a = $("away").value.trim().toLowerCase();
      const m = rows.find(r =>
        r.team1.toLowerCase()===h && r.team2.toLowerCase()===a
      ) || rows.find(r =>
        r.team1.toLowerCase()===a && r.team2.toLowerCase()===h
      );
      if(!m){ $("out").innerHTML="ไม่พบคู่นี้ใน spi.csv"; return; }

      $("out").innerHTML = `
        <h3>${m.team1} vs ${m.team2} — ${m.league} (${m.date})</h3>
        <table>
          <tr>
            <th>Date</th><th>League</th><th>Home</th><th>Away</th>
            <th>H%</th><th>D%</th><th>A%</th>
            <th>H Fair</th><th>D Fair</th><th>A Fair</th>
            <th>Over 2.5</th>
          </tr>
          ${rowHTML(m)}
        </table>`;
    };

    // ปุ่ม วันนี้ทั้งหมด
    $("today").onclick = async ()=>{
      $("out").textContent = "กำลังโหลด…";
      const rows = await ensureData();
      const today = iso(new Date());
      let lst = rows.filter(r => r.date===today);

      if(!lst.length){
        const last = rows.map(r=>r.date).sort().pop();
        lst = rows.filter(r => r.date===last);
        if(!lst.length){ $("out").innerHTML="ยังไม่พบข้อมูลใน spi.csv"; return; }
        $("out").innerHTML = `
          <h3>รายการล่าสุด (${last})</h3>
          <table>
            <tr>
              <th>Date</th><th>League</th><th>Home</th><th>Away</th>
              <th>H%</th><th>D%</th><th>A%</th>
              <th>H Fair</th><th>D Fair</th><th>A Fair</th>
              <th>Over 2.5</th>
            </tr>
            ${lst.map(rowHTML).join("")}
          </table>`;
        return;
      }

      $("out").innerHTML = `
        <h3>รายการวันนี้ (${today})</h3>
        <table>
          <tr>
            <th>Date</th><th>League</th><th>Home</th><th>Away</th>
            <th>H%</th><th>D%</th><th>A%</th>
            <th>H Fair</th><th>D Fair</th><th>A Fair</th>
            <th>Over 2.5</th>
          </tr>
          ${lst.map(rowHTML).join("")}
        </table>`;
    };
  </script>
</body>
</html>
