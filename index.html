<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Soccer — FiveThirtyEight (Probabilities & xG)</title>
  <style>
    :root{--bg:#ffffff;--fg:#111;--muted:#555;--line:#e5e7eb;--accent:#f2f6ff}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",Arial;
         background:var(--bg);color:var(--fg);margin:16px;max-width:960px}
    h1{font-size:1.4rem;margin:0 0 12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
    input,button{padding:10px;border-radius:8px;border:1px solid var(--line);font-size:1rem}
    input{min-width:240px}
    button{cursor:pointer;background:var(--accent)}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    th,td{border:1px solid var(--line);padding:8px;text-align:left;font-size:.95rem}
    th{background:#fafafa}
    .note{color:var(--muted);font-size:.9rem;margin-top:8px}
  </style>
</head>
<body>
  <h1>Live Soccer — FiveThirtyEight (Probabilities & xG)</h1>

  <div class="row">
    <label>Home: <input id="home" placeholder="เช่น Manchester City" /></label>
  </div>
  <div class="row">
    <label>Away: <input id="away" placeholder="เช่น Arsenal" /></label>
    <button id="go">Lookup</button>
  </div>
  <div class="row">
    <button id="today">วันนี้ทั้งหมด (ลีกใหญ่)</button>
  </div>

  <div id="out" class="note">พิมพ์ชื่อทีมแล้วกด Lookup หรือกด “วันนี้ทั้งหมด”</div>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
// ======= แหล่งข้อมูลหลายตัว (เรียงลำดับ fallback) =======
const SOURCES = [
  // ตรงจาก 538 (สดที่สุด)
  "https://projects.fivethirtyeight.com/soccer-api/club/spi_matches_latest.csv",
  // มิเรอร์บน jsDelivr (ดึงไฟล์จาก GitHub ของ 538 — อาจไม่สดเท่า แต่เสถียรกว่า)
  "https://cdn.jsdelivr.net/gh/fivethirtyeight/data/soccer-spi/spi_matches.csv",
  // GitHub RAW (สำรองอีกชั้น)
  "https://raw.githubusercontent.com/fivethirtyeight/data/master/soccer-spi/spi_matches.csv"
];

// proxy หลายตัว (จะหุ้มทีละ source)
const PROXIES = [
  u => u, // ไม่ใช้ proxy ก่อน (โหลดตรง)
  u => "https://cors.isomorphic-git.org/" + u,
  u => "https://r.jina.ai/http/" + u.replace(/^https?:\/\//,""),
  u => "https://api.allorigins.win/raw?url=" + encodeURIComponent(u)
];

// ======= utils =======
const $ = id => document.getElementById(id);
const pct = p => (p*100).toFixed(1)+"%";
const fair = p => p>0 ? (1/p).toFixed(2) : "-";
const iso = d => new Date(d).toISOString().slice(0,10);

let CACHE = [];

async function fetchTextMulti(){
  // ลองทีละ source x proxy
  for(const src of SOURCES){
    for(const wrap of PROXIES){
      const url = wrap(src);
      try{
        const r = await fetch(url, {cache:"no-store"});
        if(!r.ok) throw new Error("HTTP "+r.status);
        const txt = await r.text();
        // กันหน้า HTML หรือ error page
        if((txt||"").trim().slice(0,5).toLowerCase()==="<html") throw new Error("got HTML");
        return txt;
      }catch(e){
        console.warn("fail:", url, e.message);
      }
    }
  }
  throw new Error("โหลดไฟล์ไม่ได้จากทุกแหล่งและทุก proxy");
}

async function ensureData(){
  if(CACHE.length) return CACHE;
  try{
    const text = await fetchTextMulti();
    const parsed = Papa.parse(text,{header:true,dynamicTyping:true,skipEmptyLines:true});

    // รองรับทั้งไฟล์ล่าสุด (มีคอลัมน์ prob1/probtie/prob2) และไฟล์ใหญ่ (คอลัมน์ชื่ออาจต่าง)
    const rows = parsed.data.map(r=>{
      const date = String(r.date||r.match_date||"").slice(0,10);
      const league = r.league || r.competition || "";
      const team1  = r.team1 || r.home || r.team || "";
      const team2  = r.team2 || r.away || r.opponent || "";
      const prob1  = + (r.prob1 ?? r.prob_home ?? r.prob_h ?? r.prob ?? 0);
      const probtie= + (r.probtie ?? r.prob_tie ?? r.prob_draw ?? 0);
      const prob2  = + (r.prob2 ?? r.prob_away ?? r.prob_a ?? 0);
      const xg1    = + (r.xg1 ?? r.xg_home ?? 0);
      const xg2    = + (r.xg2 ?? r.xg_away ?? 0);
      return {date,league,team1,team2,prob1,probtie,prob2,xg1,xg2};
    }).filter(x=>x.date && x.team1 && x.team2);
    CACHE = rows;
    return rows;
  }catch(e){
    $("out").innerHTML =
      "โหลดข้อมูลจาก FiveThirtyEight ไม่สำเร็จ : โหลดไฟล์ไม่ได้ทั้งตรงและผ่าน proxy"+
      "<br>ลองรีเฟรช หรือสลับเครือข่าย (Wi-Fi/มือถือ)";
    throw e;
  }
}

function rowHTML(m){
  return `<tr>
    <td>${m.date}</td><td>${m.league}</td>
    <td>${m.team1}</td><td>${m.team2}</td>
    <td>${pct(m.prob1)}</td><td>${pct(m.probtie)}</td><td>${pct(m.prob2)}</td>
    <td>${fair(m.prob1)}</td><td>${fair(m.probtie)}</td><td>${fair(m.prob2)}</td>
    <td>${(m.xg1||0).toFixed(2)}–${(m.xg2||0).toFixed(2)}</td>
  </tr>`;
}

$("go").onclick = async ()=>{
  $("out").textContent = "กำลังค้นหา…";
  const rows = await ensureData();
  const h = $("home").value.trim().toLowerCase();
  const a = $("away").value.trim().toLowerCase();

  const m = rows.find(r=>r.team1.toLowerCase()===h && r.team2.toLowerCase()===a)
        || rows.find(r=>r.team1.toLowerCase()===a && r.team2.toLowerCase()===h);

  if(!m){
    $("out").innerHTML = "ไม่พบคู่นี้ในไฟล์ล่าสุด/ไฟล์ใหญ่ของ 538<br>Tip: กด “วันนี้ทั้งหมด” เพื่อดูสะกดชื่อทีมให้ตรง";
    return;
  }

  $("out").innerHTML = `
    <h3>${m.team1} vs ${m.team2} — ${m.league} (${m.date})</h3>
    <table>
      <tr><th></th><th>Home</th><th>Draw</th><th>Away</th><th>xG(Home–Away)</th></tr>
      <tr>
        <td>Probability</td><td>${pct(m.prob1)}</td><td>${pct(m.probtie)}</td><td>${pct(m.prob2)}</td>
        <td>${(m.xg1||0).toFixed(2)}–${(m.xg2||0).toFixed(2)}</td>
      </tr>
      <tr>
        <td>Fair Odds</td><td>${fair(m.prob1)}</td><td>${fair(m.probtie)}</td><td>${fair(m.prob2)}</td>
        <td>จากโมเดล 538</td>
      </tr>
    </table>`;
};

$("today").onclick = async ()=>{
  $("out").textContent = "กำลังโหลดรายการ…";
  const rows = await ensureData();
  const today = iso(new Date());
  let lst = rows.filter(r=>r.date===today);

  if(!lst.length){
    const last = rows.map(r=>r.date).filter(Boolean).sort().pop();
    lst = rows.filter(r=>r.date===last);
    if(!lst.length){ $("out").innerHTML = "ยังไม่พบข้อมูล"; return; }
    $("out").innerHTML = `
      <h3>รายการล่าสุดในไฟล์ (${last})</h3>
      <table>
        <tr><th>Date</th><th>League</th><th>Home</th><th>Away</th>
            <th>H%</th><th>D%</th><th>A%</th>
            <th>H Fair</th><th>D Fair</th><th>A Fair</th><th>xG</th></tr>
        ${lst.map(rowHTML).join("")}
      </table>`;
    return;
  }

  $("out").innerHTML = `
    <h3>รายการวันนี้ (${today})</h3>
    <table>
      <tr><th>Date</th><th>League</th><th>Home</th><th>Away</th>
          <th>H%</th><th>D%</th><th>A%</th>
          <th>H Fair</th><th>D Fair</th><th>A Fair</th><th>xG</th></tr>
      ${lst.map(rowHTML).join("")}
    </table>`;
};
</script>
