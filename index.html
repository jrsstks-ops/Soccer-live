<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Live Soccer (football-data.org) — ตารางวันนี้ + O2.5</title>
<style>
  :root{--bg:#ffffff;--fg:#111;--line:#e5e7eb}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",Arial;
       background:var(--bg);color:var(--fg);max-width:980px;margin:24px auto;padding:0 12px}
  h1{font-size:1.4rem;margin:0 0 12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button{padding:10px;border-radius:10px;border:1px solid var(--line)}
  input{min-width:240px}
  button{cursor:pointer;background:#f2f4f7}
  table{border-collapse:collapse;width:100%;margin-top:12px}
  th,td{border:1px solid var(--line);padding:8px;text-align:left}
  .note{color:#555;font-size:.9rem;margin-top:8px}
  .warn{color:#b91c1c}
  .ok{color:#065f46}
</style>
</head>
<body>
  <h1>Live Soccer — football-data.org (ตารางวันนี้ &amp; O2.5)</h1>

  <div class="row">
    <label>Home: <input id="home" placeholder="เช่น Manchester City" /></label>
    <label>Away: <input id="away" placeholder="เช่น Arsenal" /></label>
    <button id="lookup">Lookup</button>
    <button id="today">วันนี้ทั้งหมด</button>
  </div>

  <div class="note">
    ใช้ Free API ของ football-data.org ข้อมูลบางอย่างมีจำกัด/ดีเลย์<br>
    ถ้าเจอ HTTP 429 = เรียกเกินโควตา ให้รอสักครู่แล้วลองใหม่
  </div>

  <div id="out" class="note">กรอกชื่อทีมแล้วกด Lookup หรือกด “วันนี้ทั้งหมด”</div>

<script>
/* ================== ตั้งค่า ================== */
const API_KEY = "568528145148427fb89dc5484884d1ea";
const API_ROOT = "https://api.football-data.org/v4";

/* ================== ฟังก์ชันช่วย ================== */
const H = (s)=>s==null? "" : String(s);
const fmtTime = (iso)=>{
  try{ return new Date(iso).toLocaleString(); }catch{ return iso; }
};

// คำนวณความน่าจะเป็น Over 2.5 จาก Poisson distribution
function factorial(n){ let r=1; for(let i=2;i<=n;i++) r*=i; return r; }
function poissonPMF(lambda, k){ return Math.exp(-lambda)*Math.pow(lambda,k)/factorial(k); }
function over25Prob(lambdaHome, lambdaAway){
  const lam = lambdaHome + lambdaAway;
  let p = 1 - (poissonPMF(lam,0)+poissonPMF(lam,1)+poissonPMF(lam,2));
  return Math.max(0, Math.min(1, p));
}

/* ================== ดึงข้อมูลจาก API ================== */
async function fd(path, params={}){
  const url = new URL(API_ROOT + path);
  for(const [k,v] of Object.entries(params)) url.searchParams.set(k,v);
  const res = await fetch(url, { headers:{ "X-Auth-Token": API_KEY }});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function fetchMatchesByDateRange(dateFrom, dateTo){
  return fd("/matches", { dateFrom, dateTo });
}

function findMatchByTeams(matches, homeName, awayName){
  const h = homeName.trim().toLowerCase();
  const a = awayName.trim().toLowerCase();
  return matches.find(m =>
    m.homeTeam?.name?.toLowerCase() === h &&
    m.awayTeam?.name?.toLowerCase() === a
  );
}

// ดึงค่าเฉลี่ยยิง/เสีย 10 นัดล่าสุดของทีม
async function getTeamRecentAverages(teamId){
  const data = await fd(`/teams/${teamId}/matches`, { status:"FINISHED", limit:10, last:10 });
  const games = data.matches || [];
  if(games.length === 0) return {avgFor:1.2, avgAgainst:1.2}; // fallback

  let gf=0, ga=0;
  for(const g of games){
    const isHome = g.homeTeam?.id === teamId;
    const goalsFor = isHome ? g.score?.fullTime?.home : g.score?.fullTime?.away;
    const goalsAgainst = isHome ? g.score?.fullTime?.away : g.score?.fullTime?.home;
    gf += (goalsFor ?? 0);
    ga += (goalsAgainst ?? 0);
  }
  return { avgFor: gf/games.length, avgAgainst: ga/games.length };
}

/* ================== UI ================== */
function renderMatchesTable(matches){
  if(!matches.length){
    out.innerHTML = "ไม่พบข้อมูลวันนี้";
    return;
  }
  const rows = matches.map(m=>`
    <tr>
      <td>${H(m.competition?.name||"-")}</td>
      <td>${H(m.homeTeam?.name||"-")} vs ${H(m.awayTeam?.name||"-")}</td>
      <td>${fmtTime(m.utcDate)}</td>
      <td>${H(m.status)}</td>
    </tr>`).join("");
  out.innerHTML = `
    <h3>รายการวันนี้</h3>
    <table>
      <tr><th>ลีก</th><th>คู่</th><th>เวลา</th><th>สถานะ</th></tr>
      ${rows}
    </table>`;
}

function renderSingleMatchWithOver(match, o25){
  const pct = (o25*100).toFixed(1);
  const badge = o25>=0.60 ? `<b class="ok">สูง (≥60%)</b>` : 
                (o25>=0.50 ? `<b>ก้ำกึ่ง</b>` : `<b class="warn">ต่ำ (&lt;50%)</b>`);
  out.innerHTML = `
    <h3>${H(match.homeTeam?.name)} vs ${H(match.awayTeam?.name)}</h3>
    <div>ลีก: ${H(match.competition?.name||"-")} | เวลา: ${fmtTime(match.utcDate)} | สถานะ: ${H(match.status)}</div>
    <div style="margin-top:8px">โอกาสสกอร์สูง (Over 2.5): <b>${pct}%</b> ${badge}</div>
    <div class="note">* ใช้ค่าเฉลี่ยยิง/เสีย 10 นัดหลังสุด + แบบจำลอง Poisson</div>`;
}

/* ================== ปุ่ม ================== */
const out = document.getElementById("out");

document.getElementById("today").onclick = async ()=>{
  const today = new Date().toISOString().slice(0,10);
  out.innerText = "กำลังโหลดตารางวันนี้...";
  try{
    const data = await fetchMatchesByDateRange(today, today);
    renderMatchesTable(data.matches||[]);
  }catch(e){
    out.innerHTML = `โหลดข้อมูลไม่สำเร็จ: ${H(e.message)}`;
  }
};

document.getElementById("lookup").onclick = async ()=>{
  const home = document.getElementById("home").value.trim();
  const away = document.getElementById("away").value.trim();
  if(!home || !away){ out.innerText="กรอกชื่อทีมให้ครบ"; return; }

  out.innerText = "กำลังค้นหา...";
  try{
    const today = new Date().toISOString().slice(0,10);
    let data = await fetchMatchesByDateRange(today, today);
    let m = findMatchByTeams(data.matches||[], home, away);
    if(!m){
      // หาในช่วง ±3 วัน
      const d0 = new Date(); d0.setDate(d0.getDate()-3);
      const d1 = new Date(); d1.setDate(d1.getDate()+3);
      data = await fetchMatchesByDateRange(d0.toISOString().slice(0,10), d1.toISOString().slice(0,10));
      m = findMatchByTeams(data.matches||[], home, away);
    }
    if(!m){ out.innerText="ไม่พบคู่นี้"; return; }

    const hAvg = await getTeamRecentAverages(m.homeTeam.id);
    const aAvg = await getTeamRecentAverages(m.awayTeam.id);
    const lambdaH = (hAvg.avgFor + aAvg.avgAgainst)/2;
    const lambdaA = (aAvg.avgFor + hAvg.avgAgainst)/2;
    const pOver = over25Prob(lambdaH, lambdaA);

    renderSingleMatchWithOver(m, pOver);
  }catch(e){
    out.innerHTML = `โหลดข้อมูลไม่สำเร็จ: ${H(e.message)}`;
  }
};
</script>
</body>
</html>
